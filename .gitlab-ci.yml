before_script:
  - python -V
  - pip install -U setuptools pip

variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip
    - venv/

.build_venv: &build_venv
  - python -V && python -m venv venv && source venv/bin/activate

.build_pypy_venv: &build_pypy_venv
  - pypy3 -V && pypy3 -m venv venv && source venv/bin/activate

.install_deps: &install_deps
  - pip install -U setuptools pip && pip install -e . && pip install -U --pre --no-cache-dir aquests rs4 sqlphile && pip install --pre --no-cache-dir atila

.install_test_deps: &install_test_deps
  - pip install -Ur tests/requirements.txt && pip install -U --force pymongo

.install_tf: &install_tf
  - pip install -U tfserver tensorflow==1.13.2

.test_installation: &test_installation
  - python -c 'from aquests.dbapi import syndbi, asynpsycopg2, asynmongo, asynredis; from aquests.protocols.grpc import discover'

.test_pypy_installation: &test_pypy_installation
  - pypy3 -c 'from aquests.dbapi import syndbi, asynpsycopg2, asynmongo, asynredis; from aquests.protocols.grpc import discover'

.before_python_test: &before_python_test
    before_script:
      - *build_venv
      - *install_deps
      - *install_test_deps
      - *install_tf
      - *test_installation

.before_python_notf_test: &before_python_notf_test
    before_script:
      - *build_venv
      - *install_deps
      - *install_test_deps
      - *test_installation

.before_pypy_test: &before_pypy_test
    before_script:
      - *build_pypy_venv
      - *install_deps
      - *install_test_deps
      - *test_pypy_installation

.test_template: &test
  script:
    - cd tests
    - pytest level1
    - pytest level2
    - pytest level3
    - pytest level4
    - pytest level5
    - deactivate
  only:
    - master

.test_template_win32: &test-win32
  script:
    - cd tests
    - pytest level3/test_app.py
  only:
    - master

python 3.5stretch:
  image: python:3.5-stretch
  <<: *before_python_test
  <<: *test

python 3.6stretch:
  image: python:3.6-stretch
  <<: *before_python_test
  <<: *test

python 3.7stretch:
  image: python:3.7-stretch
  <<: *before_python_test
  <<: *test

python 3.8buster:
  image: python:3.8-buster
  <<: *before_python_notf_test
  <<: *test

python pypy3:
  image: pypy:3
  <<: *before_pypy_test
  <<: *test
