before_script:
  - python3 -V
  - pip3 install -U setuptools pip

.before_test: &before_test
    before_script:
      - python3 -V
      - pip3 install -U setuptools pip
      - apk add --no-cache gcc python3-dev build-base linux-headers libffi-dev postgresql-dev musl-dev
      - python3 -m venv venv
      - source venv/bin/activate
      - python setup.py install
      - pip install -U aquests rs4 sqlphile
      - pip install -U aquests rs4 sqlphile
      - python -c 'from aquests.dbapi import syndbi, asynpsycopg2, asynmongo, asynredis'
      - python -c 'from aquests.protocols.grpc import discover'
      - pip install atila
      - pip install atila
      - pip install scipy
      - pip install dnn tfserver
      - pip install -Ur tests/requirements.txt
      - pip uninstall -y bson
      - pip install -U --force pymongo

.test_template: &test
  script:
    - ./test-all.sh
    - deactivate
  only:
    - master

python 3.5alpine:
  image: python:3.5-alpine
  <<: *before_test
  <<: *test

# python 3.6alpine:
#   image: python:3.6-alpine
#   <<: *before_test
#   <<: *test

# python 3.7alpine:
#   image: python:3.7-alpine
#   <<: *before_test
#   <<: *test

# python pypy3:
#   image: pypy:3
#   <<: *before_test
#   <<: *test
