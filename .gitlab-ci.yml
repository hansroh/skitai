variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

.base_install: &base_install
  - python -V
  - pip install -U setuptools pip
  - pip install -U --pre --no-cache-dir rs4 sqlphile
  - python -c 'from skitai.concurrent.dbi import syndbi, asynpsycopg2, asynmongo, asynredis'
  - python -c 'from rs4.protocols.grpc import discover'
  - pip install -Ur tests/requirements.txt
  - pip install -U --pre --no-cache-dir atila delune
  - pip install -U --pre --no-cache-dir atila-vue
  - pip install -U --no-cache-dir rs4

.before_python_test: &before_python_test
    before_script:
      - *base_install
      - pip install -U grpcio tensorflow-cpu==2.3.0 keras==2.3.0
      - pip install -U --pre --no-cache-dir tfserver dnn

.before_python_notf_test: &before_python_notf_test
    before_script:
      - *base_install
      - pip install -U grpcio

.before_pypy_test: &before_pypy_test
    before_script:
      - rm /usr/bin/python && ln -s /usr/local/bin/pypy3 /usr/bin/python
      - *base_install

.test_template: &test
  script:
    - pip install -U -e .
    - cd tests
    - pytest level1
    - pytest level2
    - pytest level3
    - pytest level4
    - pytest level4-1
    - pytest level4-2
    - pytest level5
    # - pytest -s level4/test_big_picture.py

.test_template_win32: &test-win32
  script:
    - cd tests
    - pytest level3/test_app.py
  only:
    - master

python 3.6stretch:
  image: python:3.6-stretch
  <<: *before_python_test
  <<: *test
  only:
    - master

python 3.7stretch:
  image: python:3.7-stretch
  <<: *before_python_test
  <<: *test
  only:
    - master

python 3.8buster:
  image: python:3.8-buster
  <<: *before_python_test
  <<: *test
  only:
    - dev

python 3.9buster:
  image: python:3.9-buster
  <<: *before_python_notf_test
  <<: *test
  only:
    - master


# python pypy3:
#   image: pypy:3
#   <<: *before_pypy_test
#   <<: *test

